on:
  push:
    branches:
    - main
  pull_request:
name: ci
env:
  GOOGLE_CLOUD_PROJECT: "span-cloud-testing"
  GOOGLE_CLOUD_INSTANCE: "pgadapter-testing"
  GOOGLE_CLOUD_DATABASE: "testdb_e2e_psql"
  GOOGLE_CLOUD_ENDPOINT: "spanner.googleapis.com"
  JSON_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
jobs:
  check-env:
    outputs:
      has-key: ${{ steps.project-id.outputs.defined }}
    runs-on: ubuntu-latest
    steps:
      - id: project-id
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        if: "${{ env.GCP_PROJECT_ID != '' }}"
        run: echo "::set-output name=defined::true"
  units:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [8, 11]
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        java-version: ${{matrix.java}}
        distribution: 'zulu'
    - run: java -version
    - uses: actions/setup-go@v3
      with:
        go-version: '^1.17.7'
    - run: go version
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - run: python --version
    - run: pip install -r ./src/test/python/requirements.txt
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    - run: .ci/run-with-credentials.sh units

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        java-version: 11
        distribution: 'zulu'
    - run: java -version
    - run: .ci/run-with-credentials.sh lint
  clirr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: 8
          distribution: 'zulu'
      - run: java -version
      - run: .ci/run-with-credentials.sh clirr
  e2e-psql-v11-v1:
    needs: [check-env]
    if: needs.check-env.outputs.has-key == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        java-version: 11
        distribution: 'zulu'
    - run: java -version
    - name: "Install postgresql-client-11"
      run: |
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install postgresql-client-11
    - uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
        service_account_key: ${{ env.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
        export_default_credentials: true
    - name: "Install gcloud alpha component"
      run: gcloud components install alpha
    - run: .ci/run-with-credentials.sh uber-jar-build
    - run: .ci/run-with-credentials.sh e2e-psql 11 1.0
  e2e-psql-v11-v14:
    needs: [check-env]
    if: needs.check-env.outputs.has-key == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: 'zulu'
      - run: java -version
      - name: "Install postgresql-client-11"
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install postgresql-client-11
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          service_account_key: ${{ env.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
          export_default_credentials: true
      - name: "Install gcloud alpha component"
        run: gcloud components install alpha
      - run: .ci/run-with-credentials.sh uber-jar-build
      - run: .ci/run-with-credentials.sh e2e-psql 11 14.1
  e2e-psql-v12-v1:
    needs: [check-env]
    if: needs.check-env.outputs.has-key == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        java-version: 11
        distribution: 'zulu'
    - run: java -version
    - name: "Install postgresql-client-12"
      run: |
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install postgresql-client-12
    - uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
        service_account_key: ${{ env.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
        export_default_credentials: true
    - name: "Install gcloud alpha component"
      run: gcloud components install alpha
    - run: .ci/run-with-credentials.sh uber-jar-build
    - run: .ci/run-with-credentials.sh e2e-psql 12 1.0
  e2e-psql-v12-v1-v14:
    needs: [check-env]
    if: needs.check-env.outputs.has-key == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: 'zulu'
      - run: java -version
      - name: "Install postgresql-client-12"
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install postgresql-client-12
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          service_account_key: ${{ env.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
          export_default_credentials: true
      - name: "Install gcloud alpha component"
        run: gcloud components install alpha
      - run: .ci/run-with-credentials.sh uber-jar-build
      - run: .ci/run-with-credentials.sh e2e-psql 12 14.1
  e2e-psql-v13-v1:
    needs: [check-env]
    if: needs.check-env.outputs.has-key == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        java-version: 11
        distribution: 'zulu'
    - run: java -version
    - name: "Install postgresql-client-13"
      run: |
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install postgresql-client-13
    - uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
        service_account_key: ${{ env.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
        export_default_credentials: true
    - name: "Install gcloud alpha component"
      run: gcloud components install alpha
    - run: .ci/run-with-credentials.sh uber-jar-build
    - run: .ci/run-with-credentials.sh e2e-psql 13 1.0
  e2e-psql-v13-v14:
    needs: [check-env]
    if: needs.check-env.outputs.has-key == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: 'zulu'
      - run: java -version
      - name: "Install postgresql-client-13"
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install postgresql-client-13
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          service_account_key: ${{ env.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
          export_default_credentials: true
      - name: "Install gcloud alpha component"
        run: gcloud components install alpha
      - run: .ci/run-with-credentials.sh uber-jar-build
      - run: .ci/run-with-credentials.sh e2e-psql 13 14.1
  e2e-psql-v14-v1:
    needs: [check-env]
    if: needs.check-env.outputs.has-key == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        java-version: 11
        distribution: 'zulu'
    - run: java -version
    - name: "Install postgresql-client-14"
      run: |
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install postgresql-client-14
    - uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
        service_account_key: ${{ env.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
        export_default_credentials: true
    - name: "Install gcloud alpha component"
      run: gcloud components install alpha
    - run: .ci/run-with-credentials.sh uber-jar-build
    - run: .ci/run-with-credentials.sh e2e-psql 14 1.0
  e2e-psql-v14-v14:
    needs: [check-env]
    if: needs.check-env.outputs.has-key == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: 'zulu'
      - run: java -version
      - name: "Install postgresql-client-14"
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install postgresql-client-14
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          service_account_key: ${{ env.JSON_SERVICE_ACCOUNT_CREDENTIALS }}
          export_default_credentials: true
      - name: "Install gcloud alpha component"
        run: gcloud components install alpha
      - run: .ci/run-with-credentials.sh uber-jar-build
      - run: .ci/run-with-credentials.sh e2e-psql 14 14.1
