# PGAdapter and Liquibase

PGAdapter can be used in combination with Liquibase, but with a number of limitations. This sample
shows the command line arguments and configuration that is needed in order to use Liquibase with
PGAdapter.

## Liquibase Requirements

* PGAdapter **must** be started with the option `-ddl=AutocommitExplicitTransaction`. Cloud Spanner
  does not support DDL transactions, and this will ensure that DDL transactions are automatically
  converted to DDL batches. See [DDL options](../../../docs/ddl.md) for more information.
* The `databasechangeloglock` and `databasechangelog` tables **must** be created manually, as the
  DDL script that is automatically generated by Liquibase will try to use the data type
  `timestamp without time zone`, which is not supported by Cloud Spanner. The DDL script to create
  these tables manually can be found in
  [create_database_change_log.sql](create_database_change_log.sql).

## Running the Sample

All the steps below assume that the commands are executed from this directory.

1. Start PGAdapter with `-ddl=AutocommitExplicitTransaction`.

```shell
wget https://storage.googleapis.com/pgadapter-jar-releases/pgadapter.tar.gz && tar -xzvf pgadapter.tar.gz
java -jar pgadapter.jar -p my-project -i my-instance -ddl=AutocommitExplicitTransaction
```

2. Manually create the `databasechangeloglock` and `databasechangelog` tables. These need to be manually
   created because the default table definition that is generated by Liquibase use `timestamp without time zone`
   instead of `timestamp with time zone`, and it would create a table without a primary key.
   Replace `my-database` with the actual name of your database.

```shell
psql -h localhost -d my-database -f create_database_change_log.sql
```

3. Modify the `liquibase.properties` file in this directory to point to your database:

```
changeLogFile: dbchangelog.xml
url: jdbc:postgresql://localhost:5432/my-database
```

4. Update the database to according to the changes in `dbchangelog.xml` by executing:

```shell
mvn liquibase:update
```


