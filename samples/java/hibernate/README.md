# PGAdapter and Hibernate

PGAdapter can be used in combination with Hibernate, but with some limitations. This sample shows to use Hibernate with
PGAdapter.

> __Note__: This sample uses Hibernate directly. There is also a sample for using [Spring Data JPA
with PGAdapter here](../spring-data-jpa).

You can run the sample on the Cloud Spanner emulator with this command:

```shell
mvn exec:java
```

You can also run the sample on a real Cloud Spanner database with this command:

```shell
mvn exec:java \
  -Dexec.args=" \
    -p my-project \
    -i my-instance \
    -d my-database"
```

## PGAdapter
PGAdapter is automatically started by the sample application as an in-process dependency. Depending on the command line
arguments, one of the following will be started:
1. No command line arguments: A Docker container with both PGAdapter and the Cloud Spanner emulator is started
   automatically. The sample creates a database on the emulator and uses that for the sample application.
2. With command line arguments: Use `-p <project> -i <instance> -d <database>` to point to an existing Cloud Spanner
   PostgreSQL database that should be used for the sample. The database may be empty. The sample application will
   automatically create the tables that are needed for the sample.



## Data Types
Cloud Spanner supports the following data types in combination with `Hibernate`.

| PostgreSQL Type                        | Hibernate or Java |
|----------------------------------------|-------------------|
| boolean                                | boolean           |
| bigint / int8                          | long              |
| varchar                                | String            |
| text                                   | String            |
| float8 / double precision              | double            |
| numeric                                | BigDecimal        |
| timestamptz / timestamp with time zone | LocalDateTime     |
| bytea                                  | byte[]            |
| date                                   | LocalDate         |
| jsonb                                  | Custom Data Type  |

## Limitations
The following limitations are currently known:

| Limitation             | Workaround                                                                                                                                                                                                                                                                   |
|------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Schema updates         | Cloud Spanner does not support the full PostgreSQL DDL dialect. Automated schema updates using `hibernate` are therefore not supported. It is recommended to set the option `hibernate.hbm2ddl.auto=none` (or `spring.jpa.hibernate.ddl-auto=none` if you are using Spring). |
| Generated primary keys | Cloud Spanner does not support `sequences`. Auto-increment primary key is not supported. Remove auto increment annotation for primary key columns. The recommended type of primary key is a client side generated `UUID` stored as a string.                                 |
| Pessimistic Locking    | Cloud Spanner does not support `LockMode.UPGRADE` and `LockMode.UPGRADE_NOWAIT` lock modes.                                                                                                                                                                                  |


### Schema Updates
Schema updates are not supported as Cloud Spanner does not support the full PostgreSQL DDL dialect.
For this sample, the schema must be created manually.
See [sample-schema.sql](src/main/resources/sample-schema-sql) for the data model for this example.

It is recommended to use a higher-level schema management tool like Liquibase for gradual updates of
your schema in production. This gives you more control over the changes that are applied, and allows
you to store schema changes in a code repository. See [Spring Data JPA with PGAdapter here](../spring-data-jpa)
for an example of how to integrate Liquibase with your application.

### Generated Primary Keys
`Sequences` are not supported. Hence, auto increment primary key is not supported and should be replaced with primary key definitions that
are manually assigned. See https://cloud.google.com/spanner/docs/schema-design#primary-key-prevent-hotspots
for more information on choosing a good primary key. This sample uses UUIDs that are generated by the client for primary
keys.

```java
public class User {
	// This uses auto generated UUID.
    @Id
    @Column(columnDefinition = "varchar(36)")
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;
}
```