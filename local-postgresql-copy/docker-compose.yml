version: "3.9"
services:
  pgadapter:
#    image: "gcr.io/cloud-spanner-pg-adapter/pgadapter"
#    pull_policy: always
    image: pgadapter-pg
    container_name: ${PGADAPTER_CONTAINER_NAME}
    volumes:
      - "${GOOGLE_APPLICATION_CREDENTIALS}:/credentials.json:ro"
    command:
      - "-p ${GOOGLE_CLOUD_PROJECT}"
      - "-i ${SPANNER_INSTANCE}"
      - "-d ${SPANNER_DATABASE}"
      - "-c /credentials.json"
      - "-x"
    ports:
      - "${PGADAPTER_HOST_PORT}:5432"
  postgres:
    depends_on:
      pgadapter:
        condition: service_started
    image: "postgres"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    container_name: ${POSTGRES_CONTAINER_NAME}
    volumes:
      - "./copy-schema.sh:/docker-entrypoint-initdb.d/copy-schema.sh:ro"
      - "./import-foreign-schema.sql:/docker-entrypoint-initdb.d/import-foreign-schema.sql:ro"
      - "./copy-data.sh:/copy-data.sh:ro"
    ports:
      - "${POSTGRES_HOST_PORT}:5432"
